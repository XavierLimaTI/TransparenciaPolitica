# SECRETS and CI credentials

This document explains how to create and add the repository secrets used by the project's GitHub Actions workflows. Examples are provided for Windows PowerShell and the GitHub CLI (`gh`).

## Important secrets used by workflows

- `PORTAL_API_KEY` — API key for the Portal da Transparência (used by scheduled ingest jobs).
- `PROXY_ADMIN_TOKEN` — optional token for proxy admin endpoints (if you use the proxy).
- `FIREBASE_SERVICE_ACCOUNT` — JSON key file of a GCP Service Account with permission to upload to Firebase Storage / GCS (typically `roles/storage.admin`).
- `AWS_ACCESS_KEY_ID` / `AWS_SECRET_ACCESS_KEY` — AWS credentials for S3 upload (optional; only used if `ENABLE_S3_UPLOAD=true`).
- `AWS_REGION` — AWS region for uploading S3 objects (e.g. `us-east-1`).
- `S3_BUCKET` — S3 bucket name (ex: `legislaplay-datasets`).
- `ENABLE_S3_UPLOAD` — `true` to enable S3 upload steps in workflows.
- `SLACK_WEBHOOK_URL` — optional Slack webhook for failure notifications.
- `METRICS_URL` — optional metrics endpoint used by monthly jobs.
- `RESYNC_ENDPOINT` — optional webhook endpoint to trigger downstream resyncs.

## Create a GCP Service Account and JSON key (for `FIREBASE_SERVICE_ACCOUNT`)

1. Open Google Cloud Console: https://console.cloud.google.com/
2. Select the project you want to use for CI uploads.
3. Go to IAM & Admin → Service Accounts → Create Service Account.
   - Name: `politica-ci` (or similar)
   - Grant this service account the role `Storage Admin` (or a more restricted role limited to the target bucket).
4. After creating the account, go to the account → Keys → Add Key → Create new key → JSON.
5. Download the JSON file. Keep it secure.

Add to GitHub Secrets (two options):

- Using GitHub web UI:
  - Repository → Settings → Secrets and variables → Actions → New repository secret
  - Name: `FIREBASE_SERVICE_ACCOUNT`
  - Value: paste the entire JSON file content (or base64-encoded JSON)

- Using GitHub CLI (PowerShell example):
```powershell
# mac/windows PowerShell
Get-Content .\sa-key.json -Raw | gh secret set FIREBASE_SERVICE_ACCOUNT --body -
```

Notes:
- The workflows in this repo accept the JSON raw or base64; the upload scripts attempt to decode if necessary.
- Ensure the service account has billing/project privileges for creating buckets if you plan to create buckets from CI (recommended: create bucket manually).

## Add AWS credentials (for S3 uploads)

Create an IAM user with programmatic access and an attached policy with S3 permissions (least-privilege recommended). Record `Access key ID` and `Secret access key`.

Add to GitHub Secrets:
- `AWS_ACCESS_KEY_ID` — access key ID
- `AWS_SECRET_ACCESS_KEY` — secret access key
- `AWS_REGION` — e.g. `us-east-1`
- `S3_BUCKET` — target bucket name
- `ENABLE_S3_UPLOAD` — set to `true` to enable the S3 upload steps

PowerShell/gh CLI example:
```powershell
gh secret set AWS_ACCESS_KEY_ID --body 'AKIAXXX...'
gh secret set AWS_SECRET_ACCESS_KEY --body 'xxxxxxxx...'
gh secret set AWS_REGION --body 'us-east-1'
gh secret set S3_BUCKET --body 'meu-bucket'
gh secret set ENABLE_S3_UPLOAD --body 'true'
```

## Add Portal API key and other tokens

- `PORTAL_API_KEY` — paste your portal api key
- `PROXY_ADMIN_TOKEN` — optional

PowerShell example:
```powershell
gh secret set PORTAL_API_KEY --body 'sua_portal_api_key'
gh secret set PROXY_ADMIN_TOKEN --body 'seu_token_proxy'
```

## Adding secrets using GitHub web UI (step-by-step)
1. Go to: https://github.com/<owner>/<repo>/settings/secrets/actions
2. Click "New repository secret"
3. Enter Name (e.g. `FIREBASE_SERVICE_ACCOUNT`) and paste the secret value
4. Click "Add secret"

## Security notes and best practices
- Limit service account scopes and prefer bucket-level permissions.
- Rotate keys periodically and remove unused secrets.
- Prefer organization-level secrets or environments for production workflows.
- Avoid putting secrets in logs, outputs, or artifacts.

## Troubleshooting
- If a workflow fails due to missing secrets, check the Run logs. For GCP uploads, if `gsutil` complains about bucket not found, ensure the bucket exists and the service account has storage permissions.
- If you need help creating service accounts or keys, paste the exact error here and I can guide you step-by-step.

---
Generated by automated assistant to help configure CI secrets for this repo.
